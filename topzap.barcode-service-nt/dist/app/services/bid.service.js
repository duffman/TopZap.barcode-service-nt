'use strict';Object.defineProperty(exports,'__esModule',{value:true});const Scaledrone=require('scaledrone-node');const channel_events_1=require('../channels.git/channel-events');const channel_config_1=require('../channels.git/channel-config');const pstr_utils_1=require('../../lib/putte-ts/pstr-utils');const channel_message_1=require('../channels.git/channel-message');const zap_message_types_1=require('../models/zap-ts-models/messages/zap-message-types');const logger_1=require('../cli/logger');class BidService{constructor(apiClient){this.apiClient=apiClient;this.drone=new Scaledrone('0RgtaE9UstNGjTmu');this.channel=this.drone.subscribe(channel_config_1.MessagePipes.GetBid);this.channel.on(channel_events_1.ChannelEvents.ChannelData,data=>{this.onNewBid(data);});}formatOffer(input){let res=-1;try{let resStr=input.trim().replace(',','.');res=parseFloat(resStr);}catch(err){console.log('formatOffer :: ERROR ::',err);res=-1;}return res;}emitGetOffersInit(sessId,data){let mess=new channel_message_1.ChannelMessage(zap_message_types_1.ZapMessageType.GetOffersInit,data,sessId);this.bidsChannel.emitMessage(mess,sessId);}emitVendorOffer(sessId,data){let mess=new channel_message_1.ChannelMessage(zap_message_types_1.ZapMessageType.VendorOffer,data,sessId);this.bidsChannel.emitMessage(mess,sessId);}emitOffersDone(sessId){let mess=new channel_message_1.ChannelMessage(zap_message_types_1.ZapMessageType.GetOffersDone,{},sessId);this.bidsChannel.emitMessage(mess,sessId);}onNewBid(message){console.log('ON NEW BID ---->');let channelMess=message;let code=null;let sessId=null;try{code=channelMess.data.code;sessId=channelMess.sessId;console.log('BidChannelService :: CODE ::',code);console.log('BidChannelService :: SESSION ::',sessId);}catch(ex){code=null;}if(pstr_utils_1.PStrUtils.isEmpty(code)||pstr_utils_1.PStrUtils.isEmpty(sessId)){let err=new Error('Code or SessionId is missing');}else{this.getVendorBid(code).then(bid=>{console.log('VENDOR BID ::',bid);let messData=new channel_message_1.ChannelMessage(zap_message_types_1.ZapMessageType.VendorOffer,bid,sessId);console.log('Emitting message ::',JSON.stringify(messData));this.drone.publish({room:channel_config_1.MessagePipes.NewBid,message:messData});}).catch(err=>{logger_1.Logger.logFatalError('getVendorBid ::',err);});}}getVendorBid(code){console.log('getVendorBid ::',code);let scope=this;let result=null;return new Promise((resolve,reject)=>{this.apiClient.getOffer(code).then(res=>{if(res.offer!==null){let offerNum=scope.formatOffer(res.offer);res.accepted=offerNum>-1;res.offer=offerNum.toString();res.code=code;}resolve(res);}).catch(err=>{console.log('getOffer :: ERR',err);reject(err);});});}}exports.BidService=BidService;