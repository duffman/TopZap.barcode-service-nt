'use strict';Object.defineProperty(exports,'__esModule',{value:true});const request=require('request');const mmp_web_data_1=require('./mmp-web-data');require('./number.extensions');class MmpWebWorker{constructor(){this.baseRequest=request.defaults({'baseUrl':'https://www.musicmagpie.co.uk/start-selling/','followRedirect':false,'headers':{'user-agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36','accept-encoding':'gzip, deflate','accept-language':'en-UK','accept':'*/*'},'gzip':true});}addToCart(ean,cookieJar){return new Promise((resolve,reject)=>{this.baseRequest.head('',{'qs':{'__EVENTTARGET':'ctl00$ctl00$ctl00$ContentPlaceHolderDefault$mainContent$tabbedMediaVal2018_12$getValSmall','ctl00$ctl00$ctl00$ContentPlaceHolderDefault$mainContent$tabbedMediaVal2018_12$txtBarcode':ean},'jar':cookieJar},function optionalCallback(err,httpResponse){if(err){reject(err);}else{resolve(true);}});});}async search(ean){var jar=request.jar();await this.addToCart(ean,jar);var cartData=await this.getCart(jar);return new Promise((resolve,reject)=>{if(!cartData||!cartData.items||!cartData.items.length){resolve(null);}resolve(cartData.items[0]);});}getCart(cookieJar){return new Promise((resolve,reject)=>{this.baseRequest.get('basket-media',{'jar':cookieJar},function optionalCallback(err,httpResponse,html){if(err){reject(err);}else{let resultData;try{resultData=mmp_web_data_1.Convert.toMusicMagpieBasketResult(html);resolve(resultData);}catch(err){resolve(null);}}});});}async removeFromCart(ean,cart,jar){if(!cart){cart=await this.getCart(jar);}var item=cart.items.find(o=>o.ean===ean);if(!item){return cart;}return new Promise((resolve,reject)=>{this.baseRequest.post('basket-media',{'form':{'__EVENTTARGET':`ctl00$ctl00$ctl00$ContentPlaceHolderDefault$mainContent$BasketContents_17$rptBasket$ctl${item.no.pad(2)}$btnDelete`,'__VIEWSTATE':cart.viewstate},'jar':jar},function optionalCallback(err,httpResponse,html){if(err){reject(err);}else{let resultData;try{resultData=mmp_web_data_1.Convert.toMusicMagpieBasketResult(html);resolve(resultData);}catch(err){resolve(null);}}});});}}exports.MmpWebWorker=MmpWebWorker;