'use strict';Object.defineProperty(exports,'__esModule',{value:true});const request=require('request');const querystring=require('querystring');const cookie_jar_1=require('./cookie-jar');const logger_1=require('../../app/cli/logger');const miner_request_1=require('../../app/core/miner-request');const miner_request_2=require('../../app/core/miner-request');const session_retriever_1=require('./session-retriever');const proxy_config_1=require('./proxy-config');const global_1=require('../../inc/global');const USER_AGENT='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36';class PhpSession{constructor(){this.cookieData=null;this.phpSessionId=null;}useProxyServer(useProxy){this.useProxy=useProxy;}setPHPSessionId(sessionId,force=false){if(sessionId!=null&&this.phpSessionId==null||force&&sessionId!=null){this.phpSessionId=sessionId;}}postRequest(reqUri,payload,useProxy=false){let formData=querystring.stringify(payload);let contentLength=formData.length;if(global_1.Global.VerboseDevDebug){logger_1.Logger.logCyan('PhpSession :: postRequest');logger_1.Logger.logCyan('\t\tPHPSESSID ::',this.phpSessionId);logger_1.Logger.logCyan('\t\tUsing Proxy ::',this.phpSessionId);}let options={uri:reqUri,headers:{'user-agent':USER_AGENT,'cache-control':'no-cache','Content-Length':contentLength,'Content-Type':'application/x-www-form-urlencoded','accept':'*/*','cookie':this.phpSessionId,'x-requested-with':'XMLHttpRequest'},method:miner_request_1.MinerRequest.RequestTypeToStr(miner_request_2.RequestType.POST),body:formData};let newRequest;if(useProxy){options['ca']=proxy_config_1.ProxyConfig.getCertificate();options['requestCert']=true;options['rejectUnauthorized']=true;newRequest=request.defaults({'proxy':proxy_config_1.ProxyConfig.ProxyUrl()});}else{newRequest=request.defaults();}let scope=this;return new Promise((resolve,reject)=>{return newRequest(options,(error,response,body)=>{let reqCookie=response.headers['set-cookie'];if(reqCookie!=null){this.cookieData=new cookie_jar_1.CookieJar(reqCookie);this.setPHPSessionId(this.cookieData.getPHPSession());}if(!error&&response.statusCode==200){logger_1.Logger.logError('Success',body);resolve(body);}else{logger_1.Logger.logError('PhpSession :: postRequest :: Error',error);reject(error);}});});}executeRequest1(reqType,reqUri,payload=null){let options={uri:reqUri,headers:{'referer':'https://www.ziffit.com/basket','user-agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36','content-type':'application/json;charset=UTF-8','cookie':this.phpSessionId,'cache-control':'no-cache','accept-encoding':'gzip, deflate, br','accept':'*/*','x-requested-with':'XMLHttpRequest'},method:miner_request_1.MinerRequest.RequestTypeToStr(reqType),json:true,gzip:true};if(payload!=null){options['body']=payload;}let newRequest=request.defaults();let scope=this;return new Promise((resolve,reject)=>{function callback(error,response,body){if(!error&&response.statusCode==200){resolve(body);}else{logger_1.Logger.logError('ERROR',response);reject(error);}}newRequest(options,callback);});}executeRequest(reqType,reqUri,payload=null,useProxy=false){let formData=querystring.stringify(payload);let contentLength=formData.length;console.log('FORM-DATA:',formData);let options={uri:reqUri,headers:{'user-agent':USER_AGENT,'Content-Length':contentLength,'Content-Type':'application/x-www-form-urlencoded','cookie':this.phpSessionId,'cache-control':'no-cache','accept-encoding':'gzip, deflate, br','accept':'*/*','x-requested-with':'XMLHttpRequest'},method:miner_request_1.MinerRequest.RequestTypeToStr(reqType),body:formData,json:true,gzip:true};let newRequest;if(useProxy){options['ca']=proxy_config_1.ProxyConfig.getCertificate();options['requestCert']=true;options['rejectUnauthorized']=true;newRequest=request.defaults({'proxy':proxy_config_1.ProxyConfig.ProxyUrl()});}else{newRequest=request.defaults();}let scope=this;return new Promise((resolve,reject)=>{function callback(error,response,body){if(!error&&response.statusCode==200){resolve(body);}else{logger_1.Logger.logError('PhpSession :: executeRequest ::',response);reject(error);}}newRequest(options,callback);});}createSession(url){let scope=this;function getPhpSessionId(){return new Promise((resolve,reject)=>{let sessionRet=new session_retriever_1.SessionRetriever();sessionRet.getPHPSessionId().then(res=>{logger_1.Logger.logChainStep('### aquirePHPSessionId >> PHP Session ID ::'+res,1);resolve(res);}).catch(err=>{logger_1.Logger.logError('Error Aquiring PHP Session ID ::',err);reject(err);});});}function pokeSession(sessionId){return new Promise((resolve,reject)=>{let sessionRet=new session_retriever_1.SessionRetriever();sessionRet.initSessionId(sessionId).then(res=>{logger_1.Logger.logChainStep('### initSessionId >> PHP Session ID ::'+res,1);resolve(res);}).catch(err=>{logger_1.Logger.logError('Error initSessionId PHP Session ID ::',err);reject(err);});});}async function aquireSession(){if(scope.phpSessionId==null){let phpSessId=await getPhpSessionId();scope.setPHPSessionId(phpSessId);let initSessionRes=await pokeSession(phpSessId);}else{console.log('Session ID PRE SET AS ::',scope.phpSessionId);}}return new Promise((resolve,reject)=>{aquireSession().then(()=>{logger_1.Logger.logGreen('S');resolve();}).catch(err=>{reject(err);});});}}exports.PhpSession=PhpSession;let app=new PhpSession();let args=process.argv.slice(2);const testUrl=`https://www.webuygames.co.uk/`;switch(args[0]){case'get':app.createSession(testUrl).then(basket=>{console.log('Session Created',app.phpSessionId);});break;case'add':let code=args[1]!=null?args[1]:'0887195000424';let sessId=args[2];break;}